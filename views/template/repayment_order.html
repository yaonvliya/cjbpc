<h5 class="title-row">我的还款</h5>

<div class="pay-row">
	<label>本期还款：</label>
	<span id="toRepayAmount"></span>

</div>
<div class="pay-row" style="margin-left: 335px;margin-top: -20px;color: #75818b;">
	<span id="amountOfRepayment"></span>
</div>

<div class="pay-row">
	<label>账户余额：</label>
	<span id="availableBalance"></span>
</div>
<div class="pay-row">
	<label>到期还款日：</label>
	<span id="repayDate"></span>
</div>
<div class="pay-row">
	<label>验证码：</label>
	<div class="input-div">
		<input type="text" id="smsCaptcha" name="smsCaptchaCode" placeholder="请输入短信验证码" />
		<button type="button" id="getSmsCodeBtn" onclick="getSmsCaptcha(this)">获取验证码</button>
	</div>
</div>
<div class="mobile-row">
	<label></label>
	<span>发送至<span id="showMobile"></span></span>
</div>
<input class="row-btn" type="button" onclick="submitRepay()" value="立即还款" />

<script type="text/javascript">
	var msgFlag,InterValObj;
    var repayPlanId = BaseUtil.getUrlParams(location.hash).repayPlanId;

    $(document).ready(function () {
        if(!repayPlanId){
            layer.msg("参数错误");
            return;
        }

        getRepayInfo();

        var userInfo = commonAPIUtil.initUserInfo();
        if(userInfo){
            $("#showMobile").text(userInfo.safeLoginAccount);
        } else {
            return ;
        }
    });

    function getSmsCaptcha(obj){
        var data = {
            captchaBizType: $_GLOBAL.msgType.REPAY
        };
        AjaxUtil.ajaxPostCallBack(captchaApiUrl.getSmsCodeBindMobile, JSON.stringify(data), function (result) {
            layer.msg('发送成功');
            msgFlag = true;
            InterValObj = TimerUtil.setRemainTime(obj);
            $("#smsCaptcha").focus();
        });
    }

    function getRepayInfo(){
        var data = {
            repayPlanId: repayPlanId
        };
        var result = AjaxUtil.ajaxPostWithLoading(loanApiUrl.getRepayInfo, JSON.stringify(data));
        if(result){
            var info = result.data;
            var overdueDays = result.data.overdueDays;
						$("#toRepayAmount").text(MoneyUtil.formatMoney(info.toRepayAmount, 2) + "元");
						//还款金额说明
						if(overdueDays> 0){
						$("#amountOfRepayment").text("(本金"+MoneyUtil.formatMoney(info.principalAmount, 2) + "元+"+"利息"+MoneyUtil.formatMoney(info.interestAmount, 2) + "元"+"+逾期罚息"+MoneyUtil.formatMoney(info.overdueAmount, 2) + "元）");
							
						}else{
				
						$("#amountOfRepayment").text("(本金"+MoneyUtil.formatMoney(info.principalAmount, 2) + "元+"+"利息"+MoneyUtil.formatMoney(info.interestAmount, 2) + "元）");
							
						}
						//$("#amountOfRepayment").text("(本金"+MoneyUtil.formatMoney(info.principalAmount, 2) + "元+"+"利息"+MoneyUtil.formatMoney(info.interestAmount, 2) + "元"+"+逾期罚息"+MoneyUtil.formatMoney(info.overdueAmount, 2) + "元）");
			            $("#availableBalance").text(MoneyUtil.formatMoney(info.availableBalance, 2) + "元");
			           if(overdueDays> 0){
			           $("#repayDate").text(info.repayDate+ "(逾期"+info.overdueDays+"天)");
			           }else{
			           $("#repayDate").text(info.repayDate);
			           	
			           }
        }
			           
	}

    function submitRepay() {
        if (!msgFlag) {
            layer.msg("请先获取短信验证码！");
            return;
        }
        var smsCaptcha = $("#smsCaptcha").val();
        if(StringUtil.isEmpty(smsCaptcha)){
            layer.msg("请输入短信验证码！");
            $("#smsCaptcha").focus();
            return;
		}

		var data = {
            repayPlanId: repayPlanId,
            smsCaptchaCode: smsCaptcha
		};

        var result = AjaxUtil.ajaxPost(loanApiUrl.repay, JSON.stringify(data));
        if (result.code == '20000') {
            clearInterval(InterValObj);
            layer.msg('还款成功！', {
                time: 1000 //1秒关闭
            }, function () {
                history.go(-1);
            });
        } else if (result.code == "40404" || result.code == "40405") {
            layer.msg('由于您长时间未操作，请重新登录。', {time: 1000}, function () {
                CookieUtil.clearAllCookie();
                $_GLOBAL.jumpToLogin();
            });
        } else if (result.code == '104999') {
            layer.msg(result.message, {time: 1000}, function () {
                AjaxUtil.ajaxPostCallBack(userProfileApiUrl.authorization, null, function (res) {
                    $_GLOBAL.jumpToDeposit(res.data);
                });
            });
        } else {
            layer.msg(result.message);
        }

    }
</script>